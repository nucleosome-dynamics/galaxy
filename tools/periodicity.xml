<tool id="periodicity" name="Periodicity" version="0.1">
  <description>: analyse nucleosome position phasing and periodicity within genes</description>
  <requirements>
  <requirement type="binary">docker</requirement>
  </requirements>
  <command>
<![CDATA[
	ln -f -s $bwOutput_file $bwOutput_file\.bw;
	docker run -v $__root_dir__/database/files:$__root_dir__/database/files -v /data:/data -v /tmp:/tmp -u `id -u`:`id -g`  mmbirb/nucleosome-dynamics  periodicity --calls $gff_file --reads $rdata_file 
 	#if $assembly.source == "buildin":
	--chrom_sizes ${assembly.ref_chrom_sizes_buildin} --genes ${assembly.ref_genome_gff_buildin} 
	#else if $assembly.source == "history":
	--chrom_sizes ${assembly.ref_chrom_sizes} --genes ${assembly.ref_genome_gff_history}
	#end if
	--gffOutput $output_gff_file --type $seq_type --bwOutput $bwOutput_file\.bw --periodicity $periodicity;
	rm  $bwOutput_file\.bw 
]]>
</command>
  <inputs>
    <param name="gff_file" type="data" format="gff" label="Nucleosome Calls (GFF)" help="Nucleosome calls in GFF format as obtained from nucleR."/>
    <param name="rdata_file" type="data" format="rdata" label="Input MNase-seq/ATAC-seq reads (RData)" help="Input BAM file in RData format as generated by readBAM"/>
    <param name="seq_type" type="select" label="Type of sequence reads">
      <option value="paired">Paired</option>
      <option value="single">Single</option>
    </param>
    <conditional name="assembly">
            <param name="source" type="select" label="Select a built-in reference genome or use one from your history" help="Taking from each assembly their chromosome sizes and their annotated genes.">
                <option value="buildin" selected="True">Use a built-in genome</option>
                <option value="history">Use a genome from the history</option>
            </param>
            <when value="buildin">
	    <param name="ref_chrom_sizes_buildin" type="select" label="Select reference genome (Chrom sizes)" help="Select chromosome size for your reference genome. If your genome of interest is not listed, contact the Galaxy team.">
                    <options from_file="nucldyn_publicdata.loc">
                        <column name="name" index="2"/>
                        <column name="value" index="3"/>
                    </options>
	    </param>
	    	<param name="ref_genome_gff_buildin" type="select" label="Select reference genome (Genes)" help="Select gene annotations for your reference genome. If your genome of interest is not listed, contact the Galaxy team.">
		   <options from_file="nucldyn_publicdata.loc">
                        <column name="name" index="2"/>
                        <column name="value" index="4"/>
       		</options>
	    </param>
	</when>
            <when value="history">
                <param name="ref_chrom_sizes" type="data" format="txt" label="Reference genome (Chrom sizes)" help="Upload chromosome size for your reference genome.Check below the documentation for learning about the file format."/>
		<param name="ref_genome_gff_history" type="data" format="txt" label="Reference genome (Genes)" help=" Upload gene annotations for your reference genome. Check below the documentation for learning about the file format." />
	</when>
       </conditional>
    <param name="periodicity" size="4" type="integer" value="165" label="Period" help="Average distance between two consecutive nucleosomes (repeat length)." />  
</inputs>
  <outputs>
    <data format="gff" name="output_gff_file" label="P__${os.path.splitext(($gff_file.name.split('__'))[1])[0]}.gff" />
    <data format="bigwig" name="bwOutput_file" label="P__${os.path.splitext(($gff_file.name.split('__'))[1])[0]}.bw" />
  </outputs>
  <tests>
	  <test>
		  <param name="gff_file" value="NR__cellcycleM_chrII.gff" />
		  <param name="rdata_file" value="readBAM__cellcycleM_chrII.RData" />
		  <param name="seq_type" value="paired" />
		  <param name="ref_chrom_sizes_buildin" value="/data/nucldyn_publicdata/refGenomes/R64-1-1/R64-1-1.fa.chrom.sizes" />
		  <param name="ref_genome_gff_buildin" value="/data/nucldyn_publicdata/refGenomes/R64-1-1/genes.gff" />
		  <param name="periodicity" value="165" />
		  <output name="output_gff_file" value="P__cellcycleM_chrII.gff" />
		  <output name="bwOutput_file" value="P__cellcycleM_chrII.bw"/>
	  </test>
  </tests>
     <help>
.. image:: ${static_path}/images/NucleosomeDynamicsLogo.png
    :height: 80
    :width: 200

-----

Nucleosome Dynamics is a set of tools that take MNase-seq and ATAC-seq aligned reads and performs a serie of nucleosome-related analyses on them.

.. class:: infomark

Visit the  documentation of the original application for learning more about the accepted values and formats. http://mmb.irbbarcelona.org/NucleosomeDynamics/help/usage/nucleosome-dynamics
     </help>
   <citations>
        <citation type="bibtex">
@misc{github,
  author = {Buitrago D},
  year = {2019},
  title = {Nucleosome Dynamics suite: containerized installation},
  publisher = {GitHub},
  journal = {GitHub repository},
  url = {https://github.com/nucleosome-dynamics/nucleosome_dynamics},
}</citation>
 </citations>
</tool>
